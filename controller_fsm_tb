-- Sheikh Mohammad Sadman Sakib-301604533; Kenny Nguyen-301614035 ; Rodrigo Villalon-301621226

library ieee;
use ieee.std_logic_1164.all;

entity controller_fsm_tb is
end entity;

architecture behaviour of controller_fsm_tb is

    constant N_FLOORS_C : integer := 4;

    --inputs to controller_fsm
    signal clk            : std_logic := '0';
    signal hard_reset     : std_logic := '0';
    signal soft_reset     : std_logic := '0';
    signal estop          : std_logic := '0';
    signal has_above      : std_logic := '0';
    signal has_below      : std_logic := '0';
    signal here_req       : std_logic := '0';
    signal travel_done    : std_logic := '0';
    signal door_done      : std_logic := '0';
    signal door_close_done: std_logic := '0';

    --outputs from controller_fsm
    signal travel_enable      : std_logic;
    signal door_enable        : std_logic;
    signal door_close_enable  : std_logic;
    signal clear_req          : std_logic_vector(N_FLOORS_C-1 downto 0);
    signal current_floor      : std_logic_vector(1 downto 0);
    signal door_open          : std_logic;
    signal door_closing       : std_logic;
    signal dir_up             : std_logic;
    signal dir_down           : std_logic;
    signal estop_active       : std_logic;

begin
    DUT: entity work.controller_fsm
        generic map (
            N_FLOORS => N_FLOORS_C
        )
        port map (
            clk             => clk,
            hard_reset       => hard_reset,
            soft_reset       => soft_reset,
            estop           => estop,
            has_above       => has_above,
            has_below       => has_below,
            here_req        => here_req,
            travel_done     => travel_done,
            door_done       => door_done,
            door_close_done => door_close_done,
            travel_enable   => travel_enable,
            door_enable     => door_enable,
            door_close_enable => door_close_enable,
            clear_req        => clear_req,
            current_floor   => current_floor,
            door_open       => door_open,
            door_closing    => door_closing,
            dir_up          => dir_up,
            dir_down        => dir_down,
            estop_active    => estop_active
        );

  --- 10 ns period clock
    clkGenerator : process
    begin
        clk <= '0';
        wait for 5 ns;
        clk <= '1';
        wait for 5 ns;
    end process;


    stim_proc : process
    begin

        
        -- TEST 1: test hard reset
 
            hard_reset      <= '1';
            soft_reset      <= '0';
            estop           <= '0';
            has_above       <= '0';
            has_below       <= '0';
            here_req        <= '0';
            travel_done     <= '0';
            door_done       <= '0';
            door_close_done <= '0';

            wait for 40 ns;          -- hard reset for a few cycles

            hard_reset <= '0';       -- release hard reset

            wait for 40 ns;       -- controller should be in idle
        
        -- [TEST 1 ENDED]

        
        -- TEST 2: request at current floor while idle
        
            here_req  <= '1';
            has_above <= '0';
            has_below <= '0';

            wait for 40 ns;                -- FSM should go to door open and wait

            here_req <= '0';               -- request has been completed

            wait for 80 ns;                -- Door_open and door_enable should be active
        
        -- [TEST 2 ENDED]
        
        
        -- TEST 3: door timer finishes [door_done]
        --should move FSM from DOOR_WAIT to DOOR_CLOSE_STATE
       
            door_done <= '1';
            wait for 20 ns;
            door_done <= '0';

            wait for 80 ns;                -- door_closing/door_close_enable should be active

        -- [TEST 3 ENDED]
        

        -- TEST 4: after door closes, theres a request above

            has_above       <= '1';
            door_close_done <= '1';        -- door finished closing

            wait for 20 ns;

            door_close_done <= '0';

            wait for 80 ns;                -- FSM should start moving up, dir_up/travel_enable
        -- [TEST 4 ENDED]
        

        -- TEST 5: travel finishes 
        -- simulate reaching next floor while moving up

            travel_done <= '1';
            wait for 20 ns;
            travel_done <= '0';

            wait for 80 ns;                -- FSM arrives and opens door again

            has_above <= '0';              -- no more requests above for now
        -- [TEST 4 ENDED]
        
        -- TEST 6: emergency stop

            estop <= '1';
            wait for 40 ns;               -- estop_active should go high, all enables should go low

            estop <= '0';                  -- clear the e stop

            -- soft_reset to bring controller back to idle
            soft_reset <= '1';
            wait for 20 ns;
            soft_reset <= '0';

            wait for 80 ns;                -- back to idle state

        -- [TEST 6 ENDED]

        

        wait;  -- wait forever
    end process;

end architecture behaviour;
